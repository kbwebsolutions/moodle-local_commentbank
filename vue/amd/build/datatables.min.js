define(["jquery","core/modal_factory","core/modal_events","report_globalassign/rest","report_globalassign/main","report_globalassign/dialog_info","vuecomp/th-Filter","vuecomp/td-GradeEdit","vuecomp/td-FeedbackEdit","vuecomp/td-NotesEdit","vuecomp/td-FeedbackActions","vuecomp/td-HTMLData"],function(a,b,c,d,e,f,g,h,i,j,k,l){return{Vue:null,globalComponents:{},init:function(){var m=this,n=null,o=new f("","",(!1),(!1)),p=null,q=null,r=function(a){return'<div id="'+a+'"><datatable v-bind="data" /></div>'},s={props:["data"],template:r("dt-overview")},t={props:["data"],template:r("dt-feedback")};this.globalComponents.thFilter=g,this.globalComponents.tdGradeEdit=h,this.globalComponents.tdFeedbackEdit=i,this.globalComponents.tdNotesEdit=j,this.globalComponents.tdHTMLData=l,this.globalComponents.feedbackEdit={props:["field","value","row"],template:'<div contentEditable="true" v-if="row.cangrade">{{value}}</div><span v-else>{{value}}</span>'},this.globalComponents.notesEdit={props:["field","value","row"],template:'<div contentEditable="true" v-if="row.cangrade">{{value}}</div><span v-else>{{value}}</span>'},this.globalComponents.tdFeedbackActions=k,this.globalComponents.feedbackView={props:["value","row"],data:function(){return{extraClass:""}},methods:{modalShowFeedback:function(){if("ajaxing"!==this.extraClass){var a=this.value;o.show("Feedback",a,!0)}},modalShowEdit:function(){var e=null!==this.value?this.value:"",f='<div contentEditable="true" id="feedbacktext">'+e+"</div>",g=this;"ajaxing"!==g.extraClass&&(p?(p.setBody(f),p.show(),p.comp=g):b.create({title:"Edit feedback",type:"SAVE_CANCEL",body:f,large:!0}).then(function(b){b.show(),b.comp=g,b.getRoot().on(c.save,function(){b.comp.value=a("#feedbacktext").html(),b.comp.extraClass="ajaxing";var c=b.comp.row,e={courseid:c.courseid,gradeitemid:c.gradeitemid,userid:c.userid,feedback:b.comp.value};d.patch("update_assignment_feedback",e).then(function(a){a.success||o.show("Error","Unknown error: Failed to update feedback"),b.comp.extraClass=""})}),p=b}))}},template:'<div v-if="value || row.cangrade == 1" v-bind:class="\'cell-actions \' + extraClass"><button v-if="value" class="btn btn-secondary" v-on:click="modalShowFeedback">View</button> <button v-if="row.cangrade == 1" class="btn btn-secondary" v-on:click="modalShowEdit" >Edit</button></div>'},this.globalComponents.rowActions={props:["value","row"],methods:{saveRow:function(){var a=this;if("ajaxing"!==a.extraClass)if(a.extraClass="ajaxing",a.row.cangrade){var b={courseid:a.row.courseid,gradeitemid:a.row.gradeitemid,userid:a.row.userid,feedback:a.row.feedback,grade:a.row.finalgrade};d.patch("update_assignment_feedback_and_grade",b).then(function(b){b.success||o.show("Error","Unknown error: Failed to update feedback"),a.extraClass="",a.row.requireSave=!1})}else d.post("update_assignment_reflectivenotes",{gradeid:a.row.gradeid,reflectivenotes:a.row.reflectivenotes}).then(function(){a.extraClass="",a.row.requireSave=!1})}},template:'<button v-if="row.cangrade || row.gradeid" v-on:click="saveRow" v-bind:disabled="!row.requireSave" '+"v-bind:class=\"'save-btn btn' + (row.requireSave ? ' btn-primary' : '') + (row.extraClass ? ' ' + row.extraClass : '')\"><transition name=\"fade\"> <i class=\"fa fa-check\"></i></transition></button>"},d.get("get_assignment_overview",{query:null}).then(function(a){return n=a,d.get("get_assignment_feedbackview",{query:null})}).then(function(a){q=a;var b=[{path:"/",redirect:"/overview"},{path:"/overview",component:s,props:{data:n}},{path:"/feedback",component:t,props:{data:q}}];e.init({data:{overviewData:n,feedbackData:q},routes:b,globalComponents:m.globalComponents,watch:{"overviewData.query":{handler:function(a){d.get("get_assignment_overview",{query:JSON.stringify(a)}).then(function(a){n=a,m.Vue.overviewData.data=n.data})},deep:!0},"feedbackData.query":{handler:function(a){d.get("get_assignment_feedbackview",{query:JSON.stringify(a)}).then(function(a){q=a,m.Vue.feedbackData.data=q.data})},deep:!0}}}).then(function(a){m.Vue=a})})}}});